<!doctype html>
<html>
  <head>
    <title>Admin Dashboard - Shri Ram Restaurant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="./css/admin.css" />
  </head>

  <body>
    <div class="background-overlay"></div>

    <div class="admin-container">
      <!-- ===== SIDEBAR ===== -->
      <div class="sidebar">
        <h2>ðŸ‘‘ Admin</h2>
        <a href="#" onclick="showDashboard()">Dashboard</a>
        <a href="#" onclick="loadUsers()">Users</a>
        <a href="#" onclick="loadAdminOrders()">Orders</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>

      <!-- ===== MAIN CONTENT ===== -->
      <div class="admin-content">
        <!-- DASHBOARD -->
        <div id="dashboardSection">
          <h2>Dashboard Overview</h2>

          <div class="stats-grid">
            <div class="stat-card" onclick="loadUsers()">
              <h3 id="totalUsers">0</h3>
              <p>Total Users</p>
            </div>

            <div class="stat-card" onclick="loadAdminOrders()">
              <h3 id="totalOrders">0</h3>
              <p>Total Orders</p>
            </div>

            <div class="stat-card" onclick="loadAdminOrders()">
              <h3 id="totalRevenue">â‚¹0</h3>
              <p>Total Revenue</p>
            </div>
          </div>

          <canvas id="revenueChart"></canvas>

          <!-- ADD FOOD (ONLY DASHBOARD) -->
          <div class="add-food-box">
            <h2>Add Food</h2>
            <input type="text" id="foodName" placeholder="Food Name" />
            <input type="number" id="foodPrice" placeholder="Price" />
            <select id="foodCategory">
              <option value="">Select Category</option>
              <option value="veg">Veg</option>
              <option value="nonveg">Non-Veg</option>
              <option value="starter">Starter</option>
              <option value="coldrink">Cold Drinks</option>
            </select>
            <button onclick="addFood()">Add Food</button>
            <p id="message"></p>
          </div>
        </div>

        <!-- USERS -->
        <div id="usersSection" style="display: none">
          <h2>ðŸ‘¥ Users Management</h2>

          <input
            type="text"
            id="searchUser"
            placeholder="Search by name or email..."
            onkeyup="searchUsers()"
            class="search-input"
          />

          <div id="usersList" class="card-grid"></div>
        </div>

        <!-- ORDERS -->
        <div id="ordersSection" style="display: none">
          <h2>ðŸ“¦ Orders Management</h2>
          <div id="adminOrders" class="card-grid"></div>
        </div>
      </div>
    </div>

    <script src="./js/script.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const userData = localStorage.getItem("user");

        if (!userData) {
          alert("Please login first!");
          window.location.href = "login.html";
          return;
        }

        const user = JSON.parse(userData);

        if (!user.role || user.role.toLowerCase() !== "admin") {
          alert("Access Denied! Admin Only.");
          window.location.href = "login.html";
          return;
        }

        showDashboard();
      });

      function showDashboard() {
        document.getElementById("dashboardSection").style.display = "block";
        document.getElementById("usersSection").style.display = "none";
        document.getElementById("ordersSection").style.display = "none";
      }

      function loadUsers() {
        document.getElementById("dashboardSection").style.display = "none";
        document.getElementById("usersSection").style.display = "block";
        document.getElementById("ordersSection").style.display = "none";

        fetch("http://localhost:5000/api/users/all")
          .then((res) => res.json())
          .then((data) => {
            window.allUsers = data;
            displayUsers(data);
            document.getElementById("totalUsers").innerText = data.length;
          });
      }

      function loadAdminOrders() {
        document.getElementById("dashboardSection").style.display = "none";
        document.getElementById("usersSection").style.display = "none";
        document.getElementById("ordersSection").style.display = "block";

        fetch("http://localhost:5000/api/orders")
          .then((res) => res.json())
          .then((data) => {
            document.getElementById("totalOrders").innerText = data.length;

            let revenue = 0;
            const ordersDiv = document.getElementById("adminOrders");
            ordersDiv.innerHTML = "";

            data.forEach((order) => {
              revenue += Number(order.total);

              ordersDiv.innerHTML += `
                <div class="data-card">
                  <h3>Order ID: ${order.id}</h3>
                  <p>User ID: ${order.user_id}</p>
                  <p>Total: â‚¹${order.total}</p>
                  <p>Status: ${order.status}</p>
                </div>
              `;
            });

            document.getElementById("totalRevenue").innerText = "â‚¹" + revenue;
          });
      }

      function displayUsers(users) {
        const usersDiv = document.getElementById("usersList");
        usersDiv.innerHTML = "";

        users.forEach((u) => {
          usersDiv.innerHTML += `
            <div class="data-card">
              <h3>${u.name}</h3>
              <p>Email: ${u.email}</p>
              <p>Role: ${u.role}</p>
            </div>
          `;
        });
      }

      function searchUsers() {
        const keyword = document
          .getElementById("searchUser")
          .value.toLowerCase();

        const filtered = window.allUsers.filter(
          (u) =>
            u.name.toLowerCase().includes(keyword) ||
            u.email.toLowerCase().includes(keyword),
        );

        displayUsers(filtered);
      }

      function logout() {
        localStorage.removeItem("user");
        window.location.href = "login.html";
      }
    </script>
  </body>
</html>
